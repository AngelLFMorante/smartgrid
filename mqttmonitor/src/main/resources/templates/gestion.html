<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n Manual</title>
    <style>
        body { font-family: sans-serif; margin: 40px; }
        table { border-collapse: collapse; width: 60%; margin-bottom: 20px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        th { background-color: #f2f2f2; }
        button { padding: 6px 12px; }
        .alerta {
            background-color: #ffe0e0;
            padding: 15px;
            border: 1px solid red;
            color: darkred;
            margin-bottom: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
<h2>Gesti√≥n Manual de Dispositivos</h2>

<!-- ‚ö†Ô∏è Aviso si el l√≠mite de consumo est√° superado -->
<div th:if="${modoManual and totalActual > limitePermitido}" class="alerta">
    ‚ö†Ô∏è Has superado el l√≠mite de consumo permitido (m√°ximo [[${limitePermitido}]]W).<br/>
    Por favor, ajusta el consumo bajando o apagando dispositivos hasta estar dentro del l√≠mite.
</div>

<table>
    <tr>
        <th>Nombre</th>
        <th>Zona</th>
        <th>Criticidad</th>
        <th>Consumo</th>
        <th>Acci√≥n</th>
    </tr>
    <tr th:each="dispositivo : ${dispositivos}">
        <td th:text="${dispositivo.nombre}"></td>
        <td th:text="${dispositivo.zona}"></td>
        <td th:text="${dispositivo.criticidad}"></td>
        <td th:text="${dispositivo.consumo} + ' W'"></td>
        <td>
            <!-- üîå Apagar si no es cr√≠tico o si est√° permitido por exceso -->
            <form th:action="@{/desconectar}" method="post"
                  th:if="${dispositivo.criticidad.name() != 'CRITICA'
                          or (modoManual and totalActual > limitePermitido)}">
                <input type="hidden" name="nombre" th:value="${dispositivo.nombre}" />
                <button type="submit">üîå Apagar</button>
            </form>

            <!-- üîß Formulario para bajar potencia si es cr√≠tico y hay exceso -->
            <form th:action="@{/ajustar-potencia}" method="post"
                  th:if="${dispositivo.criticidad.name() == 'CRITICA' and modoManual and totalActual > limitePermitido}">
                <input type="hidden" name="nombre" th:value="${dispositivo.nombre}" />
                <input type="number" name="nuevaPotencia" min="1"
                       th:placeholder="'Reducir de ' + ${dispositivo.consumo} + 'W'" />
                <button type="submit">üîß Bajar Consumo</button>
            </form>

            <!-- ‚ùå Si es cr√≠tico y no se puede actuar -->
            <span th:if="${dispositivo.criticidad.name() == 'CRITICA'
                          and (!modoManual or totalActual <= limitePermitido)}">
                No disponible
            </span>
        </td>
    </tr>
</table>

<!-- ‚õî Bloquear volver mientras se est√° fuera del l√≠mite -->
<a href="/" th:if="${!modoManual or totalActual <= limitePermitido}" style="text-decoration:none;">‚¨ÖÔ∏è Volver al Dashboard</a>
<span th:if="${modoManual and totalActual > limitePermitido}" style="color: red; font-weight: bold;">
    ‚ö†Ô∏è No puedes salir hasta ajustar el consumo dentro del l√≠mite.
</span>

</body>
</html>
